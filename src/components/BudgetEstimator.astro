---
import { t, type Lang } from '../i18n/translations';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
---

<section class="estimator-section" id="estimator">
  <div class="container">
    <div class="section-header animate-on-scroll">
      <p class="section-tagline">{t(lang, 'estimator.tagline')}</p>
      <h2 class="section-title">{t(lang, 'estimator.title')}</h2>
      <p class="section-desc">{t(lang, 'estimator.desc')}</p>
    </div>

    <div class="estimator-card animate-on-scroll" id="estimator-app" data-lang={lang}>
      <div class="estimator-bg">
        <div class="est-orb est-orb-1"></div>
        <div class="est-orb est-orb-2"></div>
      </div>

      <!-- Progress bar -->
      <div class="progress-bar">
        <div class="progress-fill" id="progress-fill"></div>
      </div>
      <div class="progress-steps" id="progress-steps">
        <span class="step-indicator active" data-step="0">1</span>
        <span class="step-indicator" data-step="1">2</span>
        <span class="step-indicator" data-step="2">3</span>
        <span class="step-indicator" data-step="3">4</span>
      </div>

      <!-- Step 1: Project type -->
      <div class="step active" data-step="0">
        <h3 class="step-title">{t(lang, 'estimator.step1.title')}</h3>
        <p class="step-desc">{t(lang, 'estimator.step1.desc')}</p>
        <div class="option-grid">
          <button class="option-card" data-value="web" data-field="projectType">
            <span class="option-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="3" width="20" height="14" rx="2"/><line x1="8" y1="21" x2="16" y2="21"/><line x1="12" y1="17" x2="12" y2="21"/></svg>
            </span>
            <span class="option-label">{t(lang, 'estimator.type.web')}</span>
            <span class="option-detail">{t(lang, 'estimator.type.web.detail')}</span>
          </button>
          <button class="option-card" data-value="app" data-field="projectType">
            <span class="option-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><rect x="5" y="2" width="14" height="20" rx="2"/><line x1="12" y1="18" x2="12" y2="18.01"/></svg>
            </span>
            <span class="option-label">{t(lang, 'estimator.type.app')}</span>
            <span class="option-detail">{t(lang, 'estimator.type.app.detail')}</span>
          </button>
          <button class="option-card" data-value="ai" data-field="projectType">
            <span class="option-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2a4 4 0 0 1 4 4v2a4 4 0 0 1-8 0V6a4 4 0 0 1 4-4z"/><path d="M16 14H8a4 4 0 0 0-4 4v2h16v-2a4 4 0 0 0-4-4z"/><circle cx="9" cy="7" r="1"/><circle cx="15" cy="7" r="1"/></svg>
            </span>
            <span class="option-label">{t(lang, 'estimator.type.ai')}</span>
            <span class="option-detail">{t(lang, 'estimator.type.ai.detail')}</span>
          </button>
          <button class="option-card" data-value="consulting" data-field="projectType">
            <span class="option-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
            </span>
            <span class="option-label">{t(lang, 'estimator.type.consulting')}</span>
            <span class="option-detail">{t(lang, 'estimator.type.consulting.detail')}</span>
          </button>
        </div>
      </div>

      <!-- Step 2: Complexity -->
      <div class="step" data-step="1">
        <h3 class="step-title">{t(lang, 'estimator.step2.title')}</h3>
        <p class="step-desc">{t(lang, 'estimator.step2.desc')}</p>
        <div class="option-grid cols-3">
          <button class="option-card" data-value="basic" data-field="complexity">
            <span class="option-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/></svg>
            </span>
            <span class="option-label">{t(lang, 'estimator.complexity.basic')}</span>
            <span class="option-detail">{t(lang, 'estimator.complexity.basic.detail')}</span>
          </button>
          <button class="option-card" data-value="medium" data-field="complexity">
            <span class="option-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="4"/></svg>
            </span>
            <span class="option-label">{t(lang, 'estimator.complexity.medium')}</span>
            <span class="option-detail">{t(lang, 'estimator.complexity.medium.detail')}</span>
          </button>
          <button class="option-card" data-value="advanced" data-field="complexity">
            <span class="option-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>
            </span>
            <span class="option-label">{t(lang, 'estimator.complexity.advanced')}</span>
            <span class="option-detail">{t(lang, 'estimator.complexity.advanced.detail')}</span>
          </button>
        </div>
      </div>

      <!-- Step 3: Features -->
      <div class="step" data-step="2">
        <h3 class="step-title">{t(lang, 'estimator.step3.title')}</h3>
        <p class="step-desc">{t(lang, 'estimator.step3.desc')}</p>
        <div class="features-grid">
          <label class="feature-toggle">
            <input type="checkbox" name="feature" value="auth" />
            <span class="feature-label">{t(lang, 'estimator.feature.auth')}</span>
          </label>
          <label class="feature-toggle">
            <input type="checkbox" name="feature" value="payments" />
            <span class="feature-label">{t(lang, 'estimator.feature.payments')}</span>
          </label>
          <label class="feature-toggle">
            <input type="checkbox" name="feature" value="dashboard" />
            <span class="feature-label">{t(lang, 'estimator.feature.dashboard')}</span>
          </label>
          <label class="feature-toggle">
            <input type="checkbox" name="feature" value="api" />
            <span class="feature-label">{t(lang, 'estimator.feature.api')}</span>
          </label>
          <label class="feature-toggle">
            <input type="checkbox" name="feature" value="ai_integration" />
            <span class="feature-label">{t(lang, 'estimator.feature.ai')}</span>
          </label>
          <label class="feature-toggle">
            <input type="checkbox" name="feature" value="multilang" />
            <span class="feature-label">{t(lang, 'estimator.feature.multilang')}</span>
          </label>
          <label class="feature-toggle">
            <input type="checkbox" name="feature" value="cms" />
            <span class="feature-label">{t(lang, 'estimator.feature.cms')}</span>
          </label>
          <label class="feature-toggle">
            <input type="checkbox" name="feature" value="realtime" />
            <span class="feature-label">{t(lang, 'estimator.feature.realtime')}</span>
          </label>
        </div>
        <button class="btn-primary btn-next" id="features-next">
          {t(lang, 'estimator.next')}
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3.5 8H12.5M12.5 8L8.5 4M12.5 8L8.5 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>

      <!-- Step 4: Timeline -->
      <div class="step" data-step="3">
        <h3 class="step-title">{t(lang, 'estimator.step4.title')}</h3>
        <p class="step-desc">{t(lang, 'estimator.step4.desc')}</p>
        <div class="option-grid cols-3">
          <button class="option-card" data-value="urgent" data-field="timeline">
            <span class="option-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
            </span>
            <span class="option-label">{t(lang, 'estimator.timeline.urgent')}</span>
            <span class="option-detail">{t(lang, 'estimator.timeline.urgent.detail')}</span>
          </button>
          <button class="option-card" data-value="normal" data-field="timeline">
            <span class="option-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
            </span>
            <span class="option-label">{t(lang, 'estimator.timeline.normal')}</span>
            <span class="option-detail">{t(lang, 'estimator.timeline.normal.detail')}</span>
          </button>
          <button class="option-card" data-value="flexible" data-field="timeline">
            <span class="option-icon">
              <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            </span>
            <span class="option-label">{t(lang, 'estimator.timeline.flexible')}</span>
            <span class="option-detail">{t(lang, 'estimator.timeline.flexible.detail')}</span>
          </button>
        </div>
      </div>

      <!-- Result -->
      <div class="step" data-step="result" style="display:none;">
        <div class="result-container">
          <div class="result-icon">
            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
          </div>
          <h3 class="result-title">{t(lang, 'estimator.result.title')}</h3>
          <div class="result-estimate">
            <span class="result-range" id="result-range"></span>
          </div>
          <div class="result-details">
            <div class="result-detail">
              <span class="detail-label">{t(lang, 'estimator.result.project')}</span>
              <span class="detail-value" id="result-project"></span>
            </div>
            <div class="result-detail">
              <span class="detail-label">{t(lang, 'estimator.result.complexity')}</span>
              <span class="detail-value" id="result-complexity"></span>
            </div>
            <div class="result-detail">
              <span class="detail-label">{t(lang, 'estimator.result.features')}</span>
              <span class="detail-value" id="result-features"></span>
            </div>
            <div class="result-detail">
              <span class="detail-label">{t(lang, 'estimator.result.timeline')}</span>
              <span class="detail-value" id="result-timeline"></span>
            </div>
            <div class="result-detail">
              <span class="detail-label">{t(lang, 'estimator.result.duration')}</span>
              <span class="detail-value" id="result-duration"></span>
            </div>
          </div>
          <div class="result-comments">
            <label for="estimator-comments">{t(lang, 'estimator.result.comments')}</label>
            <textarea id="estimator-comments" rows="3" placeholder={t(lang, 'estimator.result.comments.placeholder')}></textarea>
          </div>
          <p class="result-disclaimer">{t(lang, 'estimator.result.disclaimer')}</p>
          <div class="result-actions">
            <button class="btn-primary" id="estimator-to-form" type="button">
              {t(lang, 'estimator.result.cta')}
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3.5 8H12.5M12.5 8L8.5 4M12.5 8L8.5 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
            </button>
            <button class="btn-secondary btn-restart" id="restart-estimator">
              {t(lang, 'estimator.result.restart')}
            </button>
          </div>
        </div>
      </div>

      <!-- Back button -->
      <button class="btn-back" id="btn-back" style="display:none;">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M12.5 8H3.5M3.5 8L7.5 4M3.5 8L7.5 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        {t(lang, 'estimator.back')}
      </button>
    </div>
  </div>
</section>

<style>
  .estimator-section {
    padding: var(--space-5xl) 0;
  }

  .section-header {
    text-align: center;
    margin-bottom: var(--space-3xl);
  }

  .section-desc {
    font-size: 1.05rem;
    color: var(--color-text-secondary);
    max-width: 560px;
    margin: 0 auto;
    line-height: 1.7;
  }

  .estimator-card {
    position: relative;
    padding: var(--space-3xl) var(--space-2xl);
    border-radius: var(--radius-xl);
    border: 1px solid var(--color-border);
    background: var(--color-bg-card);
    overflow: hidden;
    max-width: 740px;
    margin: 0 auto;
  }

  .estimator-bg {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .est-orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(100px);
  }

  .est-orb-1 {
    width: 250px;
    height: 250px;
    top: -20%;
    right: -10%;
    background: rgba(108, 92, 231, 0.12);
  }

  .est-orb-2 {
    width: 200px;
    height: 200px;
    bottom: -20%;
    left: -10%;
    background: rgba(0, 206, 201, 0.08);
  }

  /* Progress */
  .progress-bar {
    position: relative;
    height: 3px;
    background: var(--color-border);
    border-radius: var(--radius-full);
    margin-bottom: var(--space-md);
    overflow: hidden;
  }

  .progress-fill {
    height: 100%;
    background: var(--color-accent-gradient);
    border-radius: var(--radius-full);
    width: 25%;
    transition: width var(--transition-base);
  }

  .progress-steps {
    display: flex;
    justify-content: space-between;
    margin-bottom: var(--space-2xl);
    position: relative;
    z-index: 1;
  }

  .step-indicator {
    width: 28px;
    height: 28px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 0.75rem;
    font-weight: 700;
    border: 2px solid var(--color-border);
    color: var(--color-text-muted);
    background: var(--color-bg-card);
    transition: all var(--transition-base);
  }

  .step-indicator.active {
    border-color: var(--color-accent);
    color: white;
    background: var(--color-accent);
  }

  .step-indicator.done {
    border-color: var(--color-success);
    color: white;
    background: var(--color-success);
  }

  /* Steps */
  .step {
    display: none;
    position: relative;
    z-index: 1;
    animation: fadeInUp 0.4s ease-out;
  }

  .step.active {
    display: block;
  }

  .step-title {
    font-family: var(--font-display);
    font-size: 1.35rem;
    font-weight: 700;
    margin-bottom: var(--space-sm);
    text-align: center;
  }

  .step-desc {
    font-size: 0.95rem;
    color: var(--color-text-secondary);
    text-align: center;
    margin-bottom: var(--space-2xl);
  }

  /* Option cards */
  .option-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-md);
  }

  .option-grid.cols-3 {
    grid-template-columns: repeat(3, 1fr);
  }

  .option-card {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-sm);
    padding: var(--space-xl) var(--space-lg);
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    cursor: pointer;
    transition: all var(--transition-base);
    color: var(--color-text);
    text-align: center;
    font-family: var(--font-sans);
  }

  .option-card:hover {
    border-color: var(--color-accent);
    background: var(--color-bg-card-hover);
    transform: translateY(-2px);
  }

  .option-card.selected {
    border-color: var(--color-accent);
    background: rgba(108, 92, 231, 0.1);
    box-shadow: 0 0 0 3px var(--color-accent-glow);
  }

  .option-icon {
    color: var(--color-accent-light);
  }

  .option-label {
    font-weight: 600;
    font-size: 0.95rem;
  }

  .option-detail {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    line-height: 1.5;
  }

  /* Features */
  .features-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-sm);
    margin-bottom: var(--space-xl);
  }

  .feature-toggle {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: 0.75rem 1rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
  }

  .feature-toggle:hover {
    border-color: var(--color-accent);
  }

  .feature-toggle:has(input:checked) {
    border-color: var(--color-accent);
    background: rgba(108, 92, 231, 0.1);
  }

  .feature-toggle input {
    accent-color: var(--color-accent);
    width: 16px;
    height: 16px;
  }

  .feature-label {
    font-size: 0.9rem;
    color: var(--color-text-secondary);
  }

  .feature-toggle:has(input:checked) .feature-label {
    color: var(--color-text);
  }

  .btn-next {
    display: flex;
    margin: 0 auto;
    padding: 0.75rem 2rem;
  }

  /* Back button */
  .btn-back {
    display: inline-flex;
    align-items: center;
    gap: var(--space-xs);
    margin-top: var(--space-xl);
    font-size: 0.85rem;
    color: var(--color-text-muted);
    font-family: var(--font-sans);
    transition: color var(--transition-fast);
    position: relative;
    z-index: 1;
  }

  .btn-back:hover {
    color: var(--color-accent-light);
  }

  /* Result */
  .result-container {
    text-align: center;
  }

  .result-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 80px;
    height: 80px;
    border-radius: 50%;
    background: rgba(108, 92, 231, 0.15);
    color: var(--color-accent-light);
    margin-bottom: var(--space-xl);
    animation: pulse-glow 3s ease-in-out infinite;
  }

  .result-title {
    font-family: var(--font-display);
    font-size: 1.35rem;
    font-weight: 700;
    margin-bottom: var(--space-xl);
  }

  .result-estimate {
    margin-bottom: var(--space-2xl);
  }

  .result-range {
    font-family: var(--font-display);
    font-size: clamp(2rem, 5vw, 3rem);
    font-weight: 800;
    background: var(--color-accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
  }

  .result-details {
    display: flex;
    flex-direction: column;
    gap: var(--space-sm);
    max-width: 400px;
    margin: 0 auto var(--space-xl);
    padding: var(--space-lg);
    background: var(--color-bg);
    border-radius: var(--radius-lg);
    border: 1px solid var(--color-border);
  }

  .result-detail {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-xs) 0;
  }

  .detail-label {
    font-size: 0.85rem;
    color: var(--color-text-muted);
  }

  .detail-value {
    font-size: 0.9rem;
    font-weight: 600;
    color: var(--color-text);
  }

  .result-disclaimer {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    margin-bottom: var(--space-xl);
    font-style: italic;
  }

  .result-actions {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-lg);
    flex-wrap: wrap;
  }

  .result-comments {
    text-align: left;
    max-width: 400px;
    margin: 0 auto var(--space-xl);
  }

  .result-comments label {
    display: block;
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-xs);
  }

  .result-comments textarea {
    width: 100%;
    padding: 0.75rem 1rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    font-family: var(--font-sans);
    font-size: 0.9rem;
    resize: vertical;
    outline: none;
    transition: border-color var(--transition-fast);
  }

  .result-comments textarea::placeholder {
    color: var(--color-text-muted);
  }

  .result-comments textarea:focus {
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-glow);
  }

  .btn-restart {
    font-size: 0.9rem;
    padding: 0.75rem 1.5rem;
  }

  @media (max-width: 768px) {
    .option-grid {
      grid-template-columns: 1fr;
    }

    .option-grid.cols-3 {
      grid-template-columns: 1fr;
    }

    .features-grid {
      grid-template-columns: 1fr;
    }

    .result-actions {
      flex-direction: column;
    }
  }
</style>

<script>
  const app = document.getElementById('estimator-app');
  if (app) {
    const lang = app.dataset.lang || 'es';
    let currentStep = 0;
    const totalSteps = 4;
    const selections: Record<string, string> = {};
    let selectedFeatures: string[] = [];

    const steps = app.querySelectorAll('.step[data-step]');
    const progressFill = document.getElementById('progress-fill')!;
    const stepIndicators = app.querySelectorAll('.step-indicator');
    const btnBack = document.getElementById('btn-back')!;
    const resultStep = app.querySelector('[data-step="result"]') as HTMLElement;

    function showStep(idx: number) {
      steps.forEach((s) => {
        const el = s as HTMLElement;
        const stepVal = el.dataset.step;
        if (stepVal === 'result') return;
        el.classList.toggle('active', parseInt(stepVal!) === idx);
      });
      progressFill.style.width = `${((idx + 1) / totalSteps) * 100}%`;
      stepIndicators.forEach((ind, i) => {
        ind.classList.toggle('active', i === idx);
        ind.classList.toggle('done', i < idx);
      });
      btnBack.style.display = idx > 0 ? 'inline-flex' : 'none';
      resultStep.style.display = 'none';
      resultStep.classList.remove('active');
      currentStep = idx;
    }

    function showResult() {
      steps.forEach((s) => (s as HTMLElement).classList.remove('active'));
      resultStep.style.display = 'block';
      resultStep.classList.add('active');
      progressFill.style.width = '100%';
      stepIndicators.forEach((ind) => ind.classList.add('done'));
      btnBack.style.display = 'inline-flex';
      app.querySelector('.progress-steps')!.classList.add('done');
      calculateBudget();
    }

    // Base prices
    const basePrices: Record<string, number> = { web: 3000, app: 5000, ai: 6000, consulting: 2000 };
    const complexityMultiplier: Record<string, number> = { basic: 1, medium: 1.8, advanced: 3 };
    const featurePrices: Record<string, number> = {
      auth: 800, payments: 1200, dashboard: 1500, api: 1000,
      ai_integration: 2000, multilang: 600, cms: 900, realtime: 1400
    };
    const timelineMultiplier: Record<string, number> = { urgent: 1.4, normal: 1, flexible: 0.85 };

    const labels: Record<string, Record<string, string>> = {
      es: {
        web: 'Web / App Web', app: 'App Móvil', ai: 'Inteligencia Artificial', consulting: 'Consultoría',
        basic: 'Básico', medium: 'Intermedio', advanced: 'Avanzado',
        urgent: 'Urgente', normal: 'Normal', flexible: 'Flexible',
        auth: 'Autenticación', payments: 'Pagos', dashboard: 'Dashboard', api: 'API/Integraciones',
        ai_integration: 'IA', multilang: 'Multiidioma', cms: 'CMS', realtime: 'Tiempo real',
        weeks: 'semanas', none: 'Ninguna'
      },
      en: {
        web: 'Web / Web App', app: 'Mobile App', ai: 'Artificial Intelligence', consulting: 'Consulting',
        basic: 'Basic', medium: 'Intermediate', advanced: 'Advanced',
        urgent: 'Urgent', normal: 'Normal', flexible: 'Flexible',
        auth: 'Authentication', payments: 'Payments', dashboard: 'Dashboard', api: 'API/Integrations',
        ai_integration: 'AI', multilang: 'Multi-language', cms: 'CMS', realtime: 'Real-time',
        weeks: 'weeks', none: 'None'
      }
    };

    function calculateBudget() {
      const base = basePrices[selections.projectType] || 3000;
      const complexity = complexityMultiplier[selections.complexity] || 1;
      const timeline = timelineMultiplier[selections.timeline] || 1;
      let featuresTotal = 0;
      selectedFeatures.forEach(f => { featuresTotal += featurePrices[f] || 0; });

      const total = (base * complexity + featuresTotal) * timeline;
      const low = Math.round(total * 0.85 / 100) * 100;
      const high = Math.round(total * 1.25 / 100) * 100;

      document.getElementById('result-range')!.textContent = `${low.toLocaleString()}€ — ${high.toLocaleString()}€`;
      const l = labels[lang] || labels.es;
      document.getElementById('result-project')!.textContent = l[selections.projectType] || '';
      document.getElementById('result-complexity')!.textContent = l[selections.complexity] || '';
      document.getElementById('result-features')!.textContent =
        selectedFeatures.length > 0
          ? selectedFeatures.map(f => l[f]).join(', ')
          : l.none;
      document.getElementById('result-timeline')!.textContent = l[selections.timeline] || '';

      // Duration estimate
      const baseDuration: Record<string, number> = { web: 3, app: 5, ai: 4, consulting: 2 };
      const complexDuration: Record<string, number> = { basic: 1, medium: 1.5, advanced: 2.5 };
      const dur = Math.round((baseDuration[selections.projectType] || 3) * (complexDuration[selections.complexity] || 1));
      document.getElementById('result-duration')!.textContent = `${dur}-${dur + 2} ${l.weeks}`;
    }

    // Option card clicks (auto-advance)
    app.querySelectorAll('.option-card[data-field]').forEach((card) => {
      card.addEventListener('click', () => {
        const el = card as HTMLElement;
        const field = el.dataset.field!;
        const value = el.dataset.value!;
        selections[field] = value;

        // Visual feedback
        el.closest('.option-grid')!.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
        el.classList.add('selected');

        // Auto advance after short delay
        setTimeout(() => {
          if (currentStep < totalSteps - 1) {
            showStep(currentStep + 1);
          } else {
            showResult();
          }
        }, 300);
      });
    });

    // Features next button
    document.getElementById('features-next')?.addEventListener('click', () => {
      selectedFeatures = Array.from(app.querySelectorAll('input[name="feature"]:checked'))
        .map(el => (el as HTMLInputElement).value);
      showStep(currentStep + 1);
    });

    // Back button
    btnBack.addEventListener('click', () => {
      if (resultStep.style.display !== 'none') {
        showStep(totalSteps - 1);
      } else if (currentStep > 0) {
        showStep(currentStep - 1);
      }
    });

    // Send to contact form
    document.getElementById('estimator-to-form')?.addEventListener('click', () => {
      const l = labels[lang] || labels.es;
      const comments = (document.getElementById('estimator-comments') as HTMLTextAreaElement)?.value || '';
      const rangeText = document.getElementById('result-range')?.textContent || '';
      const durationText = document.getElementById('result-duration')?.textContent || '';
      const featuresText = selectedFeatures.length > 0
        ? selectedFeatures.map(f => l[f]).join(', ')
        : l.none;

      const estimateData = {
        projectType: l[selections.projectType] || selections.projectType,
        complexity: l[selections.complexity] || selections.complexity,
        features: featuresText,
        timeline: l[selections.timeline] || selections.timeline,
        budgetRange: rangeText,
        duration: durationText,
        comments: comments,
      };

      // Dispatch custom event for the contact form to pick up
      window.dispatchEvent(new CustomEvent('estimator-complete', { detail: estimateData }));

      // Scroll to contact
      document.getElementById('contact')?.scrollIntoView({ behavior: 'smooth' });
    });

    // Restart
    document.getElementById('restart-estimator')?.addEventListener('click', () => {
      Object.keys(selections).forEach(k => delete selections[k]);
      selectedFeatures = [];
      app.querySelectorAll('.option-card').forEach(c => c.classList.remove('selected'));
      app.querySelectorAll('input[name="feature"]').forEach(el => ((el as HTMLInputElement).checked = false));
      (document.getElementById('estimator-comments') as HTMLTextAreaElement).value = '';
      showStep(0);
    });
  }
</script>
