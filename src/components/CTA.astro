---
import { t, type Lang } from '../i18n/translations';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
---

<section class="cta-section" id="contact">
  <div class="container">
    <div class="cta-card animate-on-scroll">
      <div class="cta-bg">
        <div class="cta-orb cta-orb-1"></div>
        <div class="cta-orb cta-orb-2"></div>
      </div>
      <div class="cta-content">
        <h2 class="cta-title">{t(lang, 'cta.title')}</h2>
        <p class="cta-desc">{t(lang, 'cta.desc')}</p>

        <!-- Budget summary (hidden, shown when coming from estimator) -->
        <div class="budget-summary" id="budget-summary" style="display:none;">
          <div class="budget-summary-header">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
            <span class="budget-summary-title">{t(lang, 'form.budget.title')}</span>
            <button class="budget-summary-close" id="budget-summary-close" type="button" aria-label="Close">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            </button>
          </div>
          <div class="budget-summary-body">
            <div class="budget-summary-range" id="summary-range"></div>
            <div class="budget-summary-details">
              <span class="budget-tag" id="summary-project"></span>
              <span class="budget-tag" id="summary-complexity"></span>
              <span class="budget-tag" id="summary-timeline"></span>
              <span class="budget-tag" id="summary-duration"></span>
            </div>
            <div class="budget-summary-features" id="summary-features"></div>
          </div>
        </div>

        <form class="contact-form" id="contact-form" data-lang={lang}>
          <div class="form-row">
            <div class="form-group">
              <label for="contact-name">{t(lang, 'form.name')}</label>
              <input type="text" id="contact-name" name="name" required placeholder={t(lang, 'form.name.placeholder')} />
            </div>
            <div class="form-group">
              <label for="contact-email">{t(lang, 'form.email')}</label>
              <input type="email" id="contact-email" name="email" required placeholder={t(lang, 'form.email.placeholder')} />
            </div>
          </div>
          <div class="form-group">
            <label for="contact-company">{t(lang, 'form.company')}</label>
            <input type="text" id="contact-company" name="company" placeholder={t(lang, 'form.company.placeholder')} />
          </div>
          <div class="form-group">
            <label for="contact-service">{t(lang, 'form.service')}</label>
            <select id="contact-service" name="service">
              <option value="">{t(lang, 'form.service.placeholder')}</option>
              <option value="consulting">{t(lang, 'services.consulting.title')}</option>
              <option value="web">{t(lang, 'services.web.title')}</option>
              <option value="ai">{t(lang, 'services.ai.title')}</option>
              <option value="mvp">{t(lang, 'services.mvp.title')}</option>
            </select>
          </div>
          <div class="form-group">
            <label for="contact-message">{t(lang, 'form.message')}</label>
            <textarea id="contact-message" name="message" rows="4" required placeholder={t(lang, 'form.message.placeholder')}></textarea>
          </div>
          <!-- Hidden fields for budget data -->
          <input type="hidden" name="budget_estimate" id="hidden-budget" />
          <input type="hidden" name="budget_project" id="hidden-project" />
          <input type="hidden" name="budget_complexity" id="hidden-complexity" />
          <input type="hidden" name="budget_features" id="hidden-features" />
          <input type="hidden" name="budget_timeline" id="hidden-timeline" />
          <input type="hidden" name="budget_duration" id="hidden-duration" />
          <input type="hidden" name="budget_comments" id="hidden-comments" />

          <button type="submit" class="btn-primary btn-lg btn-submit">
            <span class="btn-text">{t(lang, 'form.submit')}</span>
            <span class="btn-loading" style="display:none;">
              <svg class="spinner" width="20" height="20" viewBox="0 0 20 20" fill="none">
                <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-dasharray="40" stroke-dashoffset="10"/>
              </svg>
            </span>
            <svg class="btn-arrow" width="16" height="16" viewBox="0 0 16 16" fill="none">
              <path d="M3.5 8H12.5M12.5 8L8.5 4M12.5 8L8.5 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="form-status" id="form-status"></div>
        </form>

        <p class="cta-note">{t(lang, 'cta.note')}</p>
      </div>
    </div>
  </div>
</section>

<style>
  .cta-section {
    padding: var(--space-5xl) 0;
  }

  .cta-card {
    position: relative;
    padding: var(--space-4xl) var(--space-2xl);
    border-radius: var(--radius-xl);
    border: 1px solid var(--color-border);
    background: var(--color-bg-card);
    overflow: hidden;
    text-align: center;
  }

  .cta-bg {
    position: absolute;
    inset: 0;
    pointer-events: none;
  }

  .cta-orb {
    position: absolute;
    border-radius: 50%;
    filter: blur(80px);
  }

  .cta-orb-1 {
    width: 300px;
    height: 300px;
    top: -30%;
    left: -10%;
    background: rgba(108, 92, 231, 0.15);
  }

  .cta-orb-2 {
    width: 250px;
    height: 250px;
    bottom: -30%;
    right: -10%;
    background: rgba(0, 206, 201, 0.1);
  }

  .cta-content {
    position: relative;
    z-index: 1;
    max-width: 600px;
    margin: 0 auto;
  }

  .cta-title {
    font-family: var(--font-display);
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 800;
    margin-bottom: var(--space-lg);
    line-height: 1.2;
  }

  .cta-desc {
    font-size: 1.05rem;
    color: var(--color-text-secondary);
    line-height: 1.7;
    margin-bottom: var(--space-2xl);
  }

  /* Budget Summary */
  .budget-summary {
    margin-bottom: var(--space-xl);
    border: 1px solid rgba(108, 92, 231, 0.3);
    border-radius: var(--radius-lg);
    background: rgba(108, 92, 231, 0.08);
    overflow: hidden;
    text-align: left;
    animation: fadeInUp 0.4s ease-out;
  }

  .budget-summary-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: 0.75rem 1rem;
    background: rgba(108, 92, 231, 0.12);
    color: var(--color-accent-light);
    font-weight: 600;
    font-size: 0.85rem;
  }

  .budget-summary-title {
    flex: 1;
  }

  .budget-summary-close {
    color: var(--color-text-muted);
    padding: 2px;
    font-family: var(--font-sans);
    transition: color var(--transition-fast);
  }

  .budget-summary-close:hover {
    color: var(--color-text);
  }

  .budget-summary-body {
    padding: 1rem;
  }

  .budget-summary-range {
    font-family: var(--font-display);
    font-size: 1.35rem;
    font-weight: 800;
    background: var(--color-accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-sm);
  }

  .budget-summary-details {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
    margin-bottom: var(--space-sm);
  }

  .budget-tag {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    color: var(--color-text-secondary);
  }

  .budget-summary-features {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    line-height: 1.5;
  }

  /* Contact Form */
  .contact-form {
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .form-group label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    letter-spacing: 0.02em;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    padding: 0.75rem 1rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    font-family: var(--font-sans);
    font-size: 0.95rem;
    transition: border-color var(--transition-fast);
    outline: none;
  }

  .form-group input::placeholder,
  .form-group textarea::placeholder {
    color: var(--color-text-muted);
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-glow);
  }

  .form-group select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12' fill='none'%3E%3Cpath d='M3 4.5L6 7.5L9 4.5' stroke='%238a8a9a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 2.5rem;
  }

  .form-group select option {
    background: var(--color-bg-card);
    color: var(--color-text);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }

  .btn-submit {
    align-self: center;
    padding: 1rem 2.5rem;
    font-size: 1.05rem;
    margin-top: var(--space-sm);
  }

  .btn-submit .spinner {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .form-status {
    text-align: center;
    font-size: 0.9rem;
    min-height: 1.5rem;
  }

  .form-status.success {
    color: var(--color-success);
  }

  .form-status.error {
    color: #e74c3c;
  }

  .btn-lg {
    padding: 1rem 2.5rem;
    font-size: 1.05rem;
  }

  .cta-note {
    margin-top: var(--space-lg);
    font-size: 0.85rem;
    color: var(--color-text-muted);
  }

  @media (max-width: 768px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  if (form) {
    const lang = form.dataset.lang || 'es';

    // Listen for estimator data
    window.addEventListener('estimator-complete', ((e: CustomEvent) => {
      const d = e.detail;
      const summary = document.getElementById('budget-summary')!;
      const featuresLabel = lang === 'es' ? 'Funcionalidades: ' : 'Features: ';

      // Show summary banner
      document.getElementById('summary-range')!.textContent = d.budgetRange;
      document.getElementById('summary-project')!.textContent = d.projectType;
      document.getElementById('summary-complexity')!.textContent = d.complexity;
      document.getElementById('summary-timeline')!.textContent = d.timeline;
      document.getElementById('summary-duration')!.textContent = d.duration;
      document.getElementById('summary-features')!.textContent = featuresLabel + d.features;
      summary.style.display = 'block';

      // Fill hidden fields
      (document.getElementById('hidden-budget') as HTMLInputElement).value = d.budgetRange;
      (document.getElementById('hidden-project') as HTMLInputElement).value = d.projectType;
      (document.getElementById('hidden-complexity') as HTMLInputElement).value = d.complexity;
      (document.getElementById('hidden-features') as HTMLInputElement).value = d.features;
      (document.getElementById('hidden-timeline') as HTMLInputElement).value = d.timeline;
      (document.getElementById('hidden-duration') as HTMLInputElement).value = d.duration;
      (document.getElementById('hidden-comments') as HTMLInputElement).value = d.comments;

      // Pre-fill message with comments if user wrote any
      const msgField = document.getElementById('contact-message') as HTMLTextAreaElement;
      if (d.comments && !msgField.value) {
        msgField.value = d.comments;
      }

      // Pre-select service based on project type
      const serviceMap: Record<string, string> = {
        'Web / App Web': 'web', 'Web / Web App': 'web',
        'App Móvil': 'mvp', 'Mobile App': 'mvp',
        'Inteligencia Artificial': 'ai', 'Artificial Intelligence': 'ai',
        'Consultoría': 'consulting', 'Consulting': 'consulting',
      };
      const serviceVal = serviceMap[d.projectType];
      if (serviceVal) {
        (document.getElementById('contact-service') as HTMLSelectElement).value = serviceVal;
      }
    }) as EventListener);

    // Close budget summary
    document.getElementById('budget-summary-close')?.addEventListener('click', () => {
      document.getElementById('budget-summary')!.style.display = 'none';
      ['hidden-budget','hidden-project','hidden-complexity','hidden-features','hidden-timeline','hidden-duration','hidden-comments']
        .forEach(id => { (document.getElementById(id) as HTMLInputElement).value = ''; });
    });

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const btnText = form.querySelector('.btn-text') as HTMLElement;
      const btnLoading = form.querySelector('.btn-loading') as HTMLElement;
      const btnArrow = form.querySelector('.btn-arrow') as HTMLElement;
      const status = document.getElementById('form-status')!;
      const submitBtn = form.querySelector('.btn-submit') as HTMLButtonElement;

      btnText.style.display = 'none';
      btnArrow.style.display = 'none';
      btnLoading.style.display = 'inline-flex';
      submitBtn.disabled = true;
      status.textContent = '';
      status.className = 'form-status';

      const formData = new FormData(form);
      const data = Object.fromEntries(formData);

      try {
        const response = await fetch('https://formspree.io/f/xyzgobpw', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          status.textContent = lang === 'es'
            ? 'Mensaje enviado con éxito. Te responderemos en menos de 24h.'
            : 'Message sent successfully. We\'ll respond within 24h.';
          status.className = 'form-status success';
          form.reset();
          document.getElementById('budget-summary')!.style.display = 'none';
        } else {
          throw new Error('Failed');
        }
      } catch {
        status.textContent = lang === 'es'
          ? 'Error al enviar. Inténtalo de nuevo o escríbenos a hello@lando.com'
          : 'Error sending. Try again or email us at hello@lando.com';
        status.className = 'form-status error';
      } finally {
        btnText.style.display = '';
        btnArrow.style.display = '';
        btnLoading.style.display = 'none';
        submitBtn.disabled = false;
      }
    });
  }
</script>
