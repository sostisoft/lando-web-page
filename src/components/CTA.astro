---
import { t, type Lang } from '../i18n/translations';
import { SITE } from '../config/site';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
---

<section class="cta-section" id="contact">
  <div class="container">
    <div class="cta-layout">
      <!-- Left: Info -->
      <div class="cta-info animate-on-scroll">
        <p class="section-tagline">{t(lang, 'nav.contact')}</p>
        <h2 class="cta-title">{t(lang, 'cta.title')}</h2>
        <p class="cta-desc">{t(lang, 'cta.desc')}</p>

        <div class="cta-features">
          <div class="cta-feature">
            <div class="cta-feature-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
            </div>
            <div>
              <span class="cta-feature-title">{t(lang, 'cta.feature.quick')}</span>
              <span class="cta-feature-desc">{t(lang, 'cta.feature.quick.desc')}</span>
            </div>
          </div>
          <div class="cta-feature">
            <div class="cta-feature-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            </div>
            <div>
              <span class="cta-feature-title">{t(lang, 'cta.feature.noobligation')}</span>
              <span class="cta-feature-desc">{t(lang, 'cta.feature.noobligation.desc')}</span>
            </div>
          </div>
          <div class="cta-feature">
            <div class="cta-feature-icon">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
            </div>
            <div>
              <span class="cta-feature-title">{t(lang, 'cta.feature.estimate')}</span>
              <span class="cta-feature-desc">{t(lang, 'cta.feature.estimate.desc')}</span>
            </div>
          </div>
        </div>

        <div class="cta-email-direct">
          <span>{t(lang, 'cta.email.label')}</span>
          <a href={`mailto:${SITE.email}`} class="cta-email-link">{SITE.email}</a>
        </div>
      </div>

      <!-- Right: Form -->
      <div class="cta-form-wrap animate-on-scroll">
        <!-- Budget summary (hidden, shown when coming from estimator) -->
        <div class="budget-summary" id="budget-summary" style="display:none;">
          <div class="budget-summary-header">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 2v4M12 18v4M4.93 4.93l2.83 2.83M16.24 16.24l2.83 2.83M2 12h4M18 12h4M4.93 19.07l2.83-2.83M16.24 7.76l2.83-2.83"/></svg>
            <span class="budget-summary-title">{t(lang, 'form.budget.title')}</span>
            <button class="budget-summary-close" id="budget-summary-close" type="button" aria-label="Close">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 4l8 8M12 4l-8 8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
            </button>
          </div>
          <div class="budget-summary-body">
            <div class="budget-summary-range" id="summary-range"></div>
            <div class="budget-summary-details">
              <span class="budget-tag" id="summary-project"></span>
              <span class="budget-tag" id="summary-complexity"></span>
              <span class="budget-tag" id="summary-timeline"></span>
              <span class="budget-tag" id="summary-duration"></span>
            </div>
            <div class="budget-summary-features" id="summary-features"></div>
          </div>
        </div>

        <form class="contact-form" id="contact-form" data-lang={lang} data-form-endpoint={SITE.formEndpoint} data-email={SITE.email}
              data-success={t(lang, 'form.success')} data-error={t(lang, 'form.error')} data-features-label={t(lang, 'estimator.result.features')}>
          <div class="form-row">
            <div class="form-group">
              <label for="contact-name">{t(lang, 'form.name')} <span aria-label={t(lang, 'form.required')}>*</span></label>
              <input type="text" id="contact-name" name="name" required aria-required="true" placeholder={t(lang, 'form.name.placeholder')} />
            </div>
            <div class="form-group">
              <label for="contact-email">{t(lang, 'form.email')} <span aria-label={t(lang, 'form.required')}>*</span></label>
              <input type="email" id="contact-email" name="email" required aria-required="true" placeholder={t(lang, 'form.email.placeholder')} />
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="contact-company">{t(lang, 'form.company')}</label>
              <input type="text" id="contact-company" name="company" placeholder={t(lang, 'form.company.placeholder')} />
            </div>
            <div class="form-group">
              <label for="contact-service">{t(lang, 'form.service')}</label>
              <select id="contact-service" name="service">
                <option value="">{t(lang, 'form.service.placeholder')}</option>
                <option value="consulting">{t(lang, 'services.consulting.title')}</option>
                <option value="web">{t(lang, 'services.web.title')}</option>
                <option value="ai">{t(lang, 'services.ai.title')}</option>
                <option value="mvp">{t(lang, 'services.mvp.title')}</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="contact-budget">{t(lang, 'form.budget')}</label>
              <select id="contact-budget" name="budget">
                <option value="">{t(lang, 'form.budget.placeholder')}</option>
                <option value="<5k">{t(lang, 'form.budget.5k')}</option>
                <option value="5k-15k">5.000€ - 15.000€</option>
                <option value="15k-50k">15.000€ - 50.000€</option>
                <option value="50k+">50.000€+</option>
                <option value="unsure">{t(lang, 'form.budget.unsure')}</option>
              </select>
            </div>
            <div class="form-group">
              <label for="contact-timeline">{t(lang, 'form.timeline')}</label>
              <select id="contact-timeline" name="timeline">
                <option value="">{t(lang, 'form.timeline.placeholder')}</option>
                <option value="urgent">{t(lang, 'form.timeline.urgent')}</option>
                <option value="1-3months">{t(lang, 'form.timeline.1-3months')}</option>
                <option value="3months+">{t(lang, 'form.timeline.3months+')}</option>
                <option value="exploring">{t(lang, 'form.timeline.exploring')}</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="contact-message">{t(lang, 'form.message')} <span aria-label={t(lang, 'form.required')}>*</span></label>
            <textarea id="contact-message" name="message" rows="4" required aria-required="true" placeholder={t(lang, 'form.message.placeholder')}></textarea>
          </div>
          <!-- Hidden fields -->
          <input type="hidden" name="lang" value={lang} />
          <input type="hidden" name="budget_estimate" id="hidden-budget" />
          <input type="hidden" name="budget_project" id="hidden-project" />
          <input type="hidden" name="budget_complexity" id="hidden-complexity" />
          <input type="hidden" name="budget_features" id="hidden-features" />
          <input type="hidden" name="budget_timeline" id="hidden-timeline" />
          <input type="hidden" name="budget_duration" id="hidden-duration" />
          <input type="hidden" name="budget_comments" id="hidden-comments" />

          <!-- RGPD consent -->
          <div class="form-consent">
            <label class="consent-label">
              <input type="checkbox" id="contact-privacy" name="privacy_accepted" required aria-required="true" />
              <span class="consent-text">
                {t(lang, 'form.consent.prefix')} <a href={t(lang, 'form.consent.url')}>{t(lang, 'form.consent.link')}</a>{t(lang, 'form.consent.suffix')} <span class="required-mark">*</span>
              </span>
            </label>
          </div>

          <button type="submit" class="btn-primary btn-submit" aria-label={t(lang, 'form.submit')}>
            <span class="btn-text">{t(lang, 'form.submit')}</span>
            <span class="btn-loading" style="display:none;" aria-live="polite">
              <svg class="spinner" width="20" height="20" viewBox="0 0 20 20" fill="none" aria-hidden="true">
                <circle cx="10" cy="10" r="8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-dasharray="40" stroke-dashoffset="10"/>
              </svg>
              <span>{t(lang, 'form.sending')}</span>
            </span>
            <svg class="btn-arrow" width="16" height="16" viewBox="0 0 16 16" fill="none" aria-hidden="true">
              <path d="M3.5 8H12.5M12.5 8L8.5 4M12.5 8L8.5 12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            </svg>
          </button>
          <div class="form-status" id="form-status"></div>
        </form>

        <p class="cta-note">{t(lang, 'cta.note')}</p>
      </div>
    </div>
  </div>
</section>

<style>
  .cta-section {
    padding: var(--space-5xl) 0;
    position: relative;
    overflow: hidden;
  }

  .cta-section::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 800px;
    height: 800px;
    background: radial-gradient(circle, rgba(37, 99, 235, 0.06) 0%, transparent 70%);
    pointer-events: none;
  }

  .cta-layout {
    display: grid;
    grid-template-columns: 1fr 1.1fr;
    gap: var(--space-4xl);
    align-items: start;
  }

  .cta-info {
    position: sticky;
    top: calc(var(--nav-height) + var(--space-2xl));
  }

  .cta-title {
    font-family: var(--font-display);
    font-size: clamp(1.75rem, 4vw, 2.5rem);
    font-weight: 800;
    margin-bottom: var(--space-lg);
    line-height: 1.2;
  }

  .cta-desc {
    font-size: 1.05rem;
    color: var(--color-text-secondary);
    line-height: 1.7;
    margin-bottom: var(--space-2xl);
  }

  .cta-features {
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    margin-bottom: var(--space-2xl);
  }

  .cta-feature {
    display: flex;
    align-items: flex-start;
    gap: var(--space-md);
  }

  .cta-feature-icon {
    flex-shrink: 0;
    width: 44px;
    height: 44px;
    border-radius: var(--radius-md);
    background: rgba(37, 99, 235, 0.1);
    border: 1px solid rgba(37, 99, 235, 0.2);
    color: var(--color-accent-light);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .cta-feature-title {
    display: block;
    font-weight: 600;
    font-size: 0.95rem;
    color: var(--color-text);
    margin-bottom: 2px;
  }

  .cta-feature-desc {
    font-size: 0.85rem;
    color: var(--color-text-muted);
  }

  .cta-email-direct {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
    padding: var(--space-lg);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
  }

  .cta-email-direct span {
    font-size: 0.85rem;
    color: var(--color-text-muted);
  }

  .cta-email-link {
    font-size: 1.1rem;
    font-weight: 700;
    background: var(--color-accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    transition: opacity var(--transition-fast);
  }

  .cta-email-link:hover {
    opacity: 0.8;
  }

  /* Form Wrap */
  .cta-form-wrap {
    padding: var(--space-2xl);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    position: relative;
    overflow: hidden;
  }

  .cta-form-wrap::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 2px;
    background: var(--color-accent-gradient);
  }

  /* Budget Summary */
  .budget-summary {
    margin-bottom: var(--space-xl);
    border: 1px solid rgba(37, 99, 235, 0.3);
    border-radius: var(--radius-lg);
    background: rgba(37, 99, 235, 0.08);
    overflow: hidden;
    text-align: left;
    animation: fadeInUp 0.4s ease-out;
  }

  .budget-summary-header {
    display: flex;
    align-items: center;
    gap: var(--space-sm);
    padding: 0.75rem 1rem;
    background: rgba(37, 99, 235, 0.12);
    color: var(--color-accent-light);
    font-weight: 600;
    font-size: 0.85rem;
  }

  .budget-summary-title {
    flex: 1;
  }

  .budget-summary-close {
    color: var(--color-text-muted);
    padding: 2px;
    font-family: var(--font-sans);
    transition: color var(--transition-fast);
  }

  .budget-summary-close:hover {
    color: var(--color-text);
  }

  .budget-summary-body {
    padding: 1rem;
  }

  .budget-summary-range {
    font-family: var(--font-display);
    font-size: 1.35rem;
    font-weight: 800;
    background: var(--color-accent-gradient);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin-bottom: var(--space-sm);
  }

  .budget-summary-details {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-xs);
    margin-bottom: var(--space-sm);
  }

  .budget-tag {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    background: var(--color-bg);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-full);
    font-size: 0.75rem;
    color: var(--color-text-secondary);
  }

  .budget-summary-features {
    font-size: 0.8rem;
    color: var(--color-text-muted);
    line-height: 1.5;
  }

  /* Contact Form */
  .contact-form {
    text-align: left;
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
  }

  .form-row {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: var(--space-lg);
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: var(--space-xs);
  }

  .form-group label {
    font-size: 0.85rem;
    font-weight: 600;
    color: var(--color-text-secondary);
    letter-spacing: 0.02em;
  }

  .form-group input,
  .form-group select,
  .form-group textarea {
    padding: 0.85rem 1rem;
    background: rgba(6, 6, 11, 0.6);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    color: var(--color-text);
    font-family: var(--font-sans);
    font-size: 0.95rem;
    transition: all var(--transition-fast);
    outline: none;
  }

  .form-group input::placeholder,
  .form-group textarea::placeholder {
    color: var(--color-text-muted);
  }

  .form-group input:focus,
  .form-group select:focus,
  .form-group textarea:focus {
    border-color: var(--color-accent);
    box-shadow: 0 0 0 3px var(--color-accent-glow), 0 0 20px rgba(37, 99, 235, 0.1);
  }

  .form-group select {
    cursor: pointer;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12' fill='none'%3E%3Cpath d='M3 4.5L6 7.5L9 4.5' stroke='%238a8a9a' stroke-width='1.5' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 1rem center;
    padding-right: 2.5rem;
  }

  .form-group select option {
    background: var(--color-bg-card);
    color: var(--color-text);
  }

  .form-group textarea {
    resize: vertical;
    min-height: 100px;
  }

  /* RGPD Consent */
  .form-consent {
    margin-top: var(--space-xs);
  }

  .consent-label {
    display: flex;
    align-items: flex-start;
    gap: var(--space-sm);
    cursor: pointer;
    font-size: 0.82rem;
    line-height: 1.6;
    color: var(--color-text-muted);
  }

  .consent-label input[type="checkbox"] {
    flex-shrink: 0;
    margin-top: 3px;
    width: 18px;
    height: 18px;
    accent-color: var(--color-accent);
    cursor: pointer;
  }

  .consent-text a {
    color: var(--color-accent-light);
    text-decoration: underline;
    text-underline-offset: 2px;
  }

  .consent-text a:hover {
    opacity: 0.8;
  }

  .required-mark {
    color: var(--color-accent-light);
    font-weight: 600;
  }

  .btn-submit {
    align-self: stretch;
    padding: 1rem 2.5rem;
    font-size: 1.05rem;
    margin-top: var(--space-sm);
    justify-content: center;
  }

  .btn-submit .spinner {
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }

  .form-status {
    text-align: center;
    font-size: 0.9rem;
    min-height: 1.5rem;
  }

  .form-status.success {
    color: var(--color-success);
  }

  .form-status.error {
    color: #e74c3c;
  }

  .cta-note {
    margin-top: var(--space-lg);
    font-size: 0.85rem;
    color: var(--color-text-muted);
    text-align: center;
  }

  @media (max-width: 900px) {
    .cta-layout {
      grid-template-columns: 1fr;
      gap: var(--space-2xl);
    }

    .cta-info {
      position: static;
      order: 2;
    }

    .cta-form-wrap {
      order: 1;
    }
  }

  @media (max-width: 600px) {
    .form-row {
      grid-template-columns: 1fr;
    }
  }
</style>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  if (form) {
    const lang = form.dataset.lang || 'es';
    const successMsg = form.dataset.success || '';
    const errorMsg = form.dataset.error || '';
    const featuresLabel = form.dataset.featuresLabel || '';

    // Listen for estimator data
    window.addEventListener('estimator-complete', ((e: CustomEvent) => {
      const d = e.detail;
      const summary = document.getElementById('budget-summary')!;

      // Show summary banner
      document.getElementById('summary-range')!.textContent = d.budgetRange;
      document.getElementById('summary-project')!.textContent = d.projectType;
      document.getElementById('summary-complexity')!.textContent = d.complexity;
      document.getElementById('summary-timeline')!.textContent = d.timeline;
      document.getElementById('summary-duration')!.textContent = d.duration;
      document.getElementById('summary-features')!.textContent = featuresLabel + ': ' + d.features;
      summary.style.display = 'block';

      // Fill hidden fields
      (document.getElementById('hidden-budget') as HTMLInputElement).value = d.budgetRange;
      (document.getElementById('hidden-project') as HTMLInputElement).value = d.projectType;
      (document.getElementById('hidden-complexity') as HTMLInputElement).value = d.complexity;
      (document.getElementById('hidden-features') as HTMLInputElement).value = d.features;
      (document.getElementById('hidden-timeline') as HTMLInputElement).value = d.timeline;
      (document.getElementById('hidden-duration') as HTMLInputElement).value = d.duration;
      (document.getElementById('hidden-comments') as HTMLInputElement).value = d.comments;

      // Pre-fill message with comments if user wrote any
      const msgField = document.getElementById('contact-message') as HTMLTextAreaElement;
      if (d.comments && !msgField.value) {
        msgField.value = d.comments;
      }

      // Pre-select service based on project type
      const serviceMap: Record<string, string> = {
        'Web / App Web': 'web', 'Web / Web App': 'web',
        'App Movil': 'mvp', 'Mobile App': 'mvp', 'App Mòbil': 'mvp', 'App Mugikorra': 'mvp',
        'Inteligencia Artificial': 'ai', 'Artificial Intelligence': 'ai', 'Intel·ligència Artificial': 'ai', 'Adimen Artifiziala': 'ai',
        'Consultoria': 'consulting', 'Consulting': 'consulting', 'Consultoría': 'consulting', 'Aholkularitza': 'consulting',
      };
      const serviceVal = serviceMap[d.projectType];
      if (serviceVal) {
        (document.getElementById('contact-service') as HTMLSelectElement).value = serviceVal;
      }

      // Auto-fill budget select from estimated range
      if (d.budgetRange) {
        const nums = d.budgetRange.replace(/[^0-9]/g, ' ').trim().split(/\s+/).map(Number);
        const high = nums.length > 1 ? nums[nums.length - 1] : nums[0];
        const budgetSelect = document.getElementById('contact-budget') as HTMLSelectElement;
        if (high < 5000) budgetSelect.value = '<5k';
        else if (high <= 15000) budgetSelect.value = '5k-15k';
        else if (high <= 50000) budgetSelect.value = '15k-50k';
        else budgetSelect.value = '50k+';
      }

      // Auto-fill timeline select from estimator
      if (d.timeline) {
        const tl = d.timeline.toLowerCase();
        const timelineSelect = document.getElementById('contact-timeline') as HTMLSelectElement;
        if (tl.includes('urgent') || tl.includes('urgente')) timelineSelect.value = 'urgent';
        else if (tl.includes('normal')) timelineSelect.value = '1-3months';
        else if (tl.includes('flexib') || tl.includes('malgu')) timelineSelect.value = '3months+';
      }
    }) as EventListener);

    // Close budget summary
    document.getElementById('budget-summary-close')?.addEventListener('click', () => {
      document.getElementById('budget-summary')!.style.display = 'none';
      ['hidden-budget','hidden-project','hidden-complexity','hidden-features','hidden-timeline','hidden-duration','hidden-comments']
        .forEach(id => { (document.getElementById(id) as HTMLInputElement).value = ''; });
    });

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const btnText = form.querySelector('.btn-text') as HTMLElement;
      const btnLoading = form.querySelector('.btn-loading') as HTMLElement;
      const btnArrow = form.querySelector('.btn-arrow') as HTMLElement;
      const status = document.getElementById('form-status')!;
      const submitBtn = form.querySelector('.btn-submit') as HTMLButtonElement;

      btnText.style.display = 'none';
      btnArrow.style.display = 'none';
      btnLoading.style.display = 'inline-flex';
      submitBtn.disabled = true;
      status.textContent = '';
      status.className = 'form-status';

      const formData = new FormData(form);
      const data = Object.fromEntries(formData);

      try {
        const response = await fetch(form.dataset.formEndpoint!, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          status.textContent = successMsg;
          status.className = 'form-status success';
          form.reset();
          document.getElementById('budget-summary')!.style.display = 'none';
        } else {
          throw new Error('Failed');
        }
      } catch {
        const email = form.dataset.email;
        status.textContent = `${errorMsg} ${email}`;
        status.className = 'form-status error';
      } finally {
        btnText.style.display = '';
        btnArrow.style.display = '';
        btnLoading.style.display = 'none';
        submitBtn.disabled = false;
      }
    });
  }
</script>
