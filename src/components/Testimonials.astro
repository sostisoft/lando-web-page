---
import { t, type Lang } from '../i18n/translations';
import { testimonials } from '../i18n/testimonials';

interface Props {
  lang: Lang;
}

const { lang } = Astro.props;
const items = testimonials[lang];
---

<section class="section" id="testimonials">
  <div class="container">
    <div class="testimonials-header animate-on-scroll">
      <p class="section-tagline">{t(lang, 'testimonials.tagline')}</p>
      <h2 class="section-title">{t(lang, 'testimonials.title')}</h2>
    </div>

    <div class="carousel-wrapper animate-on-scroll">
      <div class="carousel" id="carousel">
        <div class="carousel-track" id="carousel-track">
          {items.map((item) => (
            <div class="testimonial-card">
              <div class="testimonial-quote">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="currentColor" opacity="0.2">
                  <path d="M11 7.5V4H5V10.5C5 13.538 7.462 16 10.5 16H11V14H10.5C8.567 14 7 12.433 7 10.5V7.5H11ZM19 7.5V4H13V10.5C13 13.538 15.462 16 18.5 16H19V14H18.5C16.567 14 15 12.433 15 10.5V7.5H19Z"/>
                </svg>
              </div>
              <p class="testimonial-text">{item.text}</p>
              <div class="testimonial-author">
                <div class="author-avatar">{item.avatar}</div>
                <div class="author-info">
                  <span class="author-name">{item.name}</span>
                  <span class="author-role">{item.role} Â· {item.company}</span>
                </div>
              </div>
            </div>
          ))}
        </div>
      </div>

      <div class="carousel-controls">
        <button class="carousel-btn" id="carousel-prev" aria-label="Previous">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M12.5 15L7.5 10L12.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
        <div class="carousel-dots" id="carousel-dots"></div>
        <button class="carousel-btn" id="carousel-next" aria-label="Next">
          <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
            <path d="M7.5 15L12.5 10L7.5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
        </button>
      </div>
    </div>
  </div>
</section>

<style>
  .testimonials-header {
    text-align: center;
    max-width: 600px;
    margin: 0 auto var(--space-3xl);
  }

  .carousel-wrapper {
    max-width: 100%;
    overflow: hidden;
  }

  .carousel {
    overflow: hidden;
    margin: 0 -var(--space-lg);
    padding: 0 var(--space-lg);
  }

  .carousel-track {
    display: flex;
    gap: var(--space-lg);
    transition: transform 0.5s cubic-bezier(0.4, 0, 0.2, 1);
    cursor: grab;
  }

  .carousel-track:active {
    cursor: grabbing;
  }

  .testimonial-card {
    flex: 0 0 calc(33.333% - var(--space-lg) * 2 / 3);
    min-width: 300px;
    padding: var(--space-2xl);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-xl);
    display: flex;
    flex-direction: column;
    gap: var(--space-lg);
    transition: all var(--transition-base);
  }

  .testimonial-card:hover {
    border-color: var(--color-border-hover);
    background: var(--color-bg-card-hover);
  }

  .testimonial-quote {
    color: var(--color-accent-light);
  }

  .testimonial-text {
    font-size: 0.95rem;
    line-height: 1.75;
    color: var(--color-text-secondary);
    flex: 1;
  }

  .testimonial-author {
    display: flex;
    align-items: center;
    gap: var(--space-md);
    padding-top: var(--space-lg);
    border-top: 1px solid var(--color-border);
  }

  .author-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: var(--color-accent-gradient);
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
    font-size: 0.85rem;
    color: white;
    flex-shrink: 0;
  }

  .author-info {
    display: flex;
    flex-direction: column;
    gap: 2px;
  }

  .author-name {
    font-weight: 600;
    font-size: 0.9rem;
    color: var(--color-text);
  }

  .author-role {
    font-size: 0.8rem;
    color: var(--color-text-muted);
  }

  .carousel-controls {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-lg);
    margin-top: var(--space-2xl);
  }

  .carousel-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 1px solid var(--color-border);
    color: var(--color-text-secondary);
    transition: all var(--transition-fast);
    background: var(--color-bg-card);
  }

  .carousel-btn:hover {
    border-color: var(--color-accent-light);
    color: var(--color-accent-light);
    background: var(--color-bg-card-hover);
  }

  .carousel-dots {
    display: flex;
    gap: var(--space-sm);
  }

  :global(.carousel-dot) {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: var(--color-text-muted);
    border: none;
    cursor: pointer;
    transition: all var(--transition-fast);
    padding: 0;
  }

  :global(.carousel-dot.active) {
    width: 24px;
    border-radius: 4px;
    background: var(--color-accent-light);
  }

  @media (max-width: 1024px) {
    .testimonial-card {
      flex: 0 0 calc(50% - var(--space-lg) / 2);
    }
  }

  @media (max-width: 640px) {
    .testimonial-card {
      flex: 0 0 100%;
      min-width: unset;
    }
  }
</style>

<script>
  const track = document.getElementById('carousel-track') as HTMLElement;
  const prevBtn = document.getElementById('carousel-prev');
  const nextBtn = document.getElementById('carousel-next');
  const dotsContainer = document.getElementById('carousel-dots');

  if (track && prevBtn && nextBtn && dotsContainer) {
    const cards = track.children;
    let currentIndex = 0;
    let cardsPerView = 3;

    function updateCardsPerView() {
      if (window.innerWidth <= 640) cardsPerView = 1;
      else if (window.innerWidth <= 1024) cardsPerView = 2;
      else cardsPerView = 3;
    }

    function getMaxIndex() {
      return Math.max(0, cards.length - cardsPerView);
    }

    function createDots() {
      dotsContainer.innerHTML = '';
      const count = getMaxIndex() + 1;
      for (let i = 0; i < count; i++) {
        const dot = document.createElement('button');
        dot.classList.add('carousel-dot');
        if (i === currentIndex) dot.classList.add('active');
        dot.addEventListener('click', () => goTo(i));
        dotsContainer.appendChild(dot);
      }
    }

    function goTo(index: number) {
      currentIndex = Math.max(0, Math.min(index, getMaxIndex()));
      const card = cards[0] as HTMLElement;
      const gap = 24; // --space-lg
      const cardWidth = card.offsetWidth + gap;
      track.style.transform = `translateX(-${currentIndex * cardWidth}px)`;

      dotsContainer.querySelectorAll('.carousel-dot').forEach((dot, i) => {
        dot.classList.toggle('active', i === currentIndex);
      });
    }

    prevBtn.addEventListener('click', () => goTo(currentIndex - 1));
    nextBtn.addEventListener('click', () => goTo(currentIndex + 1));

    // Touch/drag support
    let startX = 0;
    let isDragging = false;

    track.addEventListener('touchstart', (e) => {
      startX = e.touches[0].clientX;
      isDragging = true;
    }, { passive: true });

    track.addEventListener('touchend', (e) => {
      if (!isDragging) return;
      const diff = startX - e.changedTouches[0].clientX;
      if (Math.abs(diff) > 50) {
        if (diff > 0) goTo(currentIndex + 1);
        else goTo(currentIndex - 1);
      }
      isDragging = false;
    });

    // Auto-play
    let autoPlay = setInterval(() => {
      if (currentIndex >= getMaxIndex()) goTo(0);
      else goTo(currentIndex + 1);
    }, 5000);

    track.closest('.carousel-wrapper')?.addEventListener('mouseenter', () => clearInterval(autoPlay));
    track.closest('.carousel-wrapper')?.addEventListener('mouseleave', () => {
      autoPlay = setInterval(() => {
        if (currentIndex >= getMaxIndex()) goTo(0);
        else goTo(currentIndex + 1);
      }, 5000);
    });

    window.addEventListener('resize', () => {
      updateCardsPerView();
      createDots();
      goTo(Math.min(currentIndex, getMaxIndex()));
    });

    updateCardsPerView();
    createDots();
  }
</script>
